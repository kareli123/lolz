    <!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>Crypto Escrow</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Подключаем премиум шрифт Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --bg-color: #090909; 
            --card-bg: #141414; 
            --card-border: #222222; 
            --primary: #27F597; 
            --primary-glow: rgba(39, 245, 151, 0.35);
            --text-main: #ffffff; 
            --text-sec: #808080; 
            --input-bg: #0f0f0f; 
            --danger: #ff4b4b; 
        }

        body { 
            background-color: var(--bg-color); 
            background-image: radial-gradient(circle at 50% -10%, rgba(39, 245, 151, 0.08) 0%, rgba(9,9,9,1) 50%);
            background-attachment: fixed; 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 0; 
            padding-bottom: 110px; 
            -webkit-tap-highlight-color: transparent; 
            -webkit-font-smoothing: antialiased;
        }
        
        * { box-sizing: border-box; user-select: none; outline: none; -webkit-tap-highlight-color: transparent; }

        /* HEADER & USER */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; margin-bottom: 5px; }
        .user-pill { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 42px; height: 42px; border-radius: 50%; background: #222; border: 1px solid var(--card-border); background-size: cover; background-position: center; }
        
        .u-name { 
            font-size: 16px; 
            font-weight: 700; 
            color: #fff; 
            letter-spacing: -0.02em;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            -webkit-text-stroke: 0.3px rgba(0,0,0,0.5);
        }
        
        .u-tag { font-size: 12px; color: var(--text-sec); font-weight: 500; margin-top: 2px; }
        
        .logo-img { height: 32px; width: auto; object-fit: contain; }

        /* BALANCE CARD */
        .balance-card { 
            margin: 10px 20px 20px; 
            padding: 30px 20px; 
            background: var(--card-bg); 
            border: 1px solid var(--card-border); 
            border-radius: 24px; 
            text-align: center; 
            position: relative;
            overflow: hidden;
        }
        .balance-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.03) 0%, transparent 60%);
            pointer-events: none;
        }

        .balance-val { 
            font-size: 44px; 
            font-weight: 800; 
            letter-spacing: -1.5px; 
            margin: 8px 0 16px; 
            color: #fff;
        }
        
        .dep-badge { 
            background: rgba(255, 255, 255, 0.05); 
            color: #aaa; 
            padding: 6px 16px; 
            border-radius: 100px; 
            font-size: 13px; 
            font-weight: 500; 
            display: inline-flex; 
            align-items: center; gap: 6px;
        }

        /* ACTIONS GRID */
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 20px 20px; }
        .act-btn { 
            background: var(--card-bg); 
            border: 1px solid var(--card-border); 
            border-radius: 20px; 
            height: 80px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-weight: 600; 
            font-size: 13px; 
            cursor: pointer; 
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            color: #fff;
        }
        .act-btn:active { transform: scale(0.97); opacity: 0.8; }
        .act-btn i { font-size: 22px; margin-bottom: 8px; color: var(--text-sec); transition: 0.2s; }
        
        .act-btn.green i { color: var(--primary); }
        .act-btn.green { 
            background: rgba(39, 245, 151, 0.03); 
            border-color: rgba(39, 245, 151, 0.15); 
        }

        /* === PREMIUM BUTTONS === */
        .main-btn { 
            width: 100%; 
            height: 54px;
            background: var(--primary); 
            color: #000; 
            border: none; 
            border-radius: 16px; 
            font-size: 16px; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.2s; 
            box-shadow: 0 4px 20px var(--primary-glow);
            letter-spacing: -0.3px;
        }
        .main-btn:active { transform: scale(0.96); opacity: 0.9; box-shadow: 0 2px 10px var(--primary-glow); }
        .main-btn:disabled { background: #333; color: #666; box-shadow: none; transform: none; }
        
        .sm-btn { 
            width: 100%; 
            padding: 14px; 
            background: rgba(255, 255, 255, 0.05); 
            color: #fff; 
            border: none; 
            border-radius: 14px; 
            font-weight: 600; 
            font-size: 14px;
            cursor: pointer; 
            margin-top: 10px; 
        }
        .sm-btn:active { background: rgba(255, 255, 255, 0.08); }

        /* TABBAR */
        .tabbar { 
            position: fixed; bottom: 20px; left: 20px; right: 20px; height: 65px; 
            background: rgba(20, 20, 20, 0.9); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border); 
            border-radius: 20px; 
            display: flex; justify-content: space-around; align-items: center; 
            z-index: 100; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
        }
        .tab { color: #555; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: 0.3s; width: 60px; }
        .tab.active { color: #fff; }
        .tab.active i { color: var(--primary); text-shadow: 0 0 20px var(--primary); transform: translateY(-2px); }
        .tab i { font-size: 20px; transition: 0.3s; margin-bottom: 2px; }

        /* PAGES & ANIMATIONS */
        .page { display: none; animation: fade 0.25s ease-out; padding-bottom: 100px; }
        .page.active { display: block; }
        @keyframes fade { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform: translateY(0); } }

        /* MODALS */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 199; opacity: 0; pointer-events: none; transition: 0.3s; }
        .overlay.vis { opacity: 1; pointer-events: auto; }
        
        .sheet { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #121212; 
            border-radius: 24px 24px 0 0; 
            padding: 24px 20px 40px; 
            transform: translateY(100%); 
            transition: 0.35s cubic-bezier(0.19, 1, 0.22, 1); 
            z-index: 200; 
            border-top: 1px solid var(--card-border); 
            max-height: 90vh; overflow-y: auto; 
        }
        .sheet.vis { transform: translateY(0); }
        .sheet h3 { margin: 0 0 20px 0; font-size: 20px; font-weight: 700; text-align: center; }

        /* INPUTS */
        .inp { 
            width: 100%; 
            background: #0a0a0a; 
            border: 1px solid var(--card-border); 
            color: white; 
            padding: 16px; 
            border-radius: 14px; 
            margin-bottom: 12px; 
            font-size: 15px; 
            font-family: 'Inter', sans-serif;
            transition: 0.2s; 
        }
        .inp:focus { border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary); }
        .inp::placeholder { color: #444; }
        .inp.error { border-color: var(--danger); color: var(--danger); }

        /* LIST ITEMS */
        .mini-card { background: var(--card-bg); padding: 12px; border-radius: 16px; display: flex; align-items: center; gap: 14px; border: 1px solid var(--card-border); position: relative; margin-bottom: 8px; }
        .mini-img { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; }
        .mini-info h5 { margin: 0; font-size: 15px; font-weight: 600; color: #fff; margin-bottom: 2px; }
        .mini-info p { margin: 0; font-size: 12px; color: var(--text-sec); }
        .del-btn { position: absolute; right: 10px; color: var(--text-sec); background: none; border: none; font-size: 20px; padding: 5px; cursor: pointer; }
        
        .add-row { display: flex; gap: 10px; align-items: center; }
        .add-btn { width: 54px; height: 54px; background: #0a0a0a; border: 1px solid var(--card-border); color: var(--primary); border-radius: 14px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; transition: 0.2s; }
        .add-btn:active { transform: scale(0.95); }

        /* DEALS */
        .deal-item { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 18px; padding: 16px; margin-bottom: 12px; }
        .deal-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .deal-amount { font-size: 18px; font-weight: 700; color: #fff; }
        .deal-desc { font-size: 13px; color: var(--text-sec); margin-bottom: 12px; line-height: 1.4; }
        
        .deal-status { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .st-active { background: rgba(255, 193, 7, 0.1); color: #ffc107; border: 1px solid rgba(255, 193, 7, 0.2); }
        .st-paid { background: rgba(39, 245, 151, 0.1); color: var(--primary); border: 1px solid rgba(39, 245, 151, 0.2); }
        .st-shipped { background: rgba(255, 255, 255, 0.1); color: #fff; border: 1px solid rgba(255, 255, 255, 0.2); }
        
        .gift-info { background: rgba(39, 245, 151, 0.05); border: 1px dashed rgba(39, 245, 151, 0.3); border-radius: 12px; padding: 14px; font-size: 13px; color: #ccc; margin-top: 10px; line-height: 1.4; }
        .gift-link-inline { color: var(--primary); text-decoration: none; font-weight: 700; }

        .wd-item { display: flex; align-items: center; padding: 18px; background: var(--card-bg); margin-bottom: 10px; border-radius: 16px; cursor: pointer; border: 1px solid var(--card-border); transition: 0.2s; }
        .wd-item:active { background: #222; transform: scale(0.98); }
        .wd-item i { font-size: 20px; margin-right: 15px; width: 30px; text-align: center; color: var(--text-sec); }
        #wd-form { display: none; } #wd-list { display: block; }

        .success-scr { position: fixed; inset: 0; background: var(--bg-color); z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        .success-icon-box { width: 90px; height: 90px; border-radius: 50%; background: rgba(39, 245, 151, 0.1); display: flex; align-items: center; justify-content: center; margin-bottom: 24px; box-shadow: 0 0 30px rgba(39, 245, 151, 0.15); }

        .btn-dual { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; width: 100%; }
        
        .price-big { font-size: 42px; font-weight: 800; color: #fff; margin: 10px 0; letter-spacing: -1px; }
    </style>
</head>
<body>

<div id="success" class="success-scr">
    <div class="success-icon-box">
        <i class="fa-solid fa-check" style="font-size: 40px; color: var(--primary);"></i>
    </div>
    <h2 style="font-size: 24px; font-weight: 800; margin-bottom: 10px; letter-spacing: -0.5px;">Оплата прошла!</h2>
    <p style="color: var(--text-sec); font-size: 15px; line-height: 1.6; margin-bottom: 40px;">Продавец получил уведомление.<br>Ожидайте передачу товара.</p>
    <button class="main-btn" onclick="backToMenu()">В главное меню</button>
</div>

<!-- ЭКРАН ПОКУПАТЕЛЯ -->
<div id="buyer" class="page">
    <div class="header"><div class="brand">Guarantor</div></div>
    <div style="padding: 20px;">
        <h3 style="text-align: center; margin-bottom: 24px; font-weight: 700;">Покупка товаров</h3>
        <div id="buyer-items" style="display:grid; gap:10px; margin-bottom:24px;"></div>
        <div style="background: var(--card-bg); border-radius: 24px; padding: 30px; border: 1px solid var(--card-border); text-align: center;">
            <div style="font-size: 13px; color: var(--text-sec); font-weight: 500;">К оплате</div>
            <div class="price-big" id="b-price">0 ₽</div>
        </div>
        <button class="main-btn" onclick="pay()" style="margin-top: 30px;">Оплатить</button>
    </div>
</div>

<!-- ЭКРАН ГЛАВНАЯ -->
<div id="home" class="page active">
    <div class="header">
        <div class="user-pill"><div class="avatar"></div><div><div class="u-name">User</div><div class="u-tag">@username</div></div></div>
        <img src="logo.png" class="logo-img" alt="Logo">
    </div>
    <div class="balance-card">
        <div style="color: var(--text-sec); font-size: 13px; font-weight: 500;">Общий баланс</div>
        <div class="balance-val">0,00 ₽</div>
        <div class="dep-badge"><i class="fa-solid fa-wallet"></i> Депозит: 0 ₽</div>
    </div>
    <div class="actions">
        <div class="act-btn green"><i class="fa-solid fa-circle-plus"></i>Пополнить</div>
        <div class="act-btn" onclick="openWithdraw()"><i class="fa-solid fa-arrow-up-right-from-square"></i>Вывести</div>
    </div>
    <div style="padding: 0 20px;">
        <button class="main-btn" onclick="openM()"><i class="fa-solid fa-plus" style="margin-right: 8px;"></i> Новая сделка</button>
    </div>
</div>

<!-- ЭКРАН СДЕЛКИ -->
<div id="deals" class="page">
    <div class="header"><div class="brand">Мои сделки</div></div>
    <div id="deals-list" style="padding: 0 20px;">
        <div style="text-align: center; color: var(--text-sec); margin-top: 60px;">
            <i class="fa-regular fa-folder-open" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i><br>Список пуст
        </div>
    </div>
</div>

<!-- ЭКРАН ПРОФИЛЬ -->
<div id="profile" class="page">
    <div class="header"><div class="brand">Профиль</div></div>
    <div style="text-align:center; margin-top:40px; margin-bottom: 40px;">
        <div class="avatar" style="width:100px; height:100px; margin:0 auto 15px; border: 3px solid var(--card-border);"></div>
        <h2 class="u-name" style="font-size: 24px;">User</h2>
        <div class="u-tag" style="font-size: 14px;">@username</div>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:0 20px;">
        <div style="background:var(--card-bg); padding:20px; border-radius:20px; text-align:center; border: 1px solid var(--card-border);">
            <div id="stat-deals" style="color:var(--primary); font-size:24px; font-weight:800;">0</div>
            <div style="font-size:12px; color:var(--text-sec); margin-top: 6px;">Сделок</div>
        </div>
        <div style="background:var(--card-bg); padding:20px; border-radius:20px; text-align:center; border: 1px solid var(--card-border);">
            <div id="stat-turnover" style="color:#fff; font-size:20px; font-weight:800;">0 ₽</div>
            <div style="font-size:12px; color:var(--text-sec); margin-top: 6px;">Оборот</div>
        </div>
    </div>
</div>

<div class="tabbar">
    <div class="tab active" onclick="nav('home', this)"><i class="fa-solid fa-house"></i><span>Главная</span></div>
    <div class="tab" onclick="nav('deals', this)"><i class="fa-solid fa-briefcase"></i><span>Сделки</span></div>
    <div class="tab" onclick="nav('profile', this)"><i class="fa-solid fa-user"></i><span>Профиль</span></div>
</div>

<!-- МОДАЛКИ -->
<div class="overlay" id="overlay" onclick="closeAll()"></div>

<div class="sheet" id="sheet">
    <h3>Новая сделка</h3>
    <div id="items-list"></div>
    <div class="add-row">
        <input type="text" class="inp" id="lnk" placeholder="Ссылка на NFT (t.me/nft/...)" style="margin-bottom: 12px;">
        <button class="add-btn" onclick="addItem()">+</button>
    </div>
    <div id="parse-status" style="font-size:12px; color:var(--text-sec); margin: -5px 0 20px 5px;"></div>
    <input type="number" class="inp" id="prc" placeholder="Сумма сделки (RUB)">
    <div id="res" style="display:none; background: #0a0a0a; padding: 16px; border-radius: 12px; color: var(--primary); margin-bottom: 16px; word-break: break-all; border: 1px dashed var(--primary); font-size: 13px;"></div>
    
    <div id="gen-controls">
        <button class="main-btn" id="cBtn" onclick="gen()">Создать ссылку</button>
    </div>
    <div id="final-controls" class="btn-dual" style="display:none;">
        <button class="main-btn" id="copyBtn">Копировать</button>
        <button class="main-btn" id="shareBtn" style="background: rgba(255,255,255,0.1); color: #fff; box-shadow: none;">Поделиться</button>
    </div>
</div>

<div class="sheet" id="withdraw-sheet">
    <div id="wd-list">
        <h3>Вывести средства</h3>
        <div class="wd-item" onclick="selectMethod('USDT')"><i class="fa-brands fa-bitcoin"></i> USDT (TRC20)</div>
        <div class="wd-item" onclick="selectMethod('Card RU')"><i class="fa-regular fa-credit-card"></i> Карта (RU)</div>
        <div class="wd-item" onclick="selectMethod('SBP')"><i class="fa-solid fa-mobile-screen"></i> СБП</div>
        <div class="wd-item" onclick="selectMethod('TON')"><i class="fa-regular fa-gem"></i> TON Wallet</div>
    </div>
    <div id="wd-form" style="display: none;">
        <h3 id="wd-title">Вывод</h3>
        <input type="text" class="inp" id="wd-req" placeholder="Реквизиты получателя">
        <input type="number" class="inp" id="wd-sum" placeholder="Сумма">
        <button class="main-btn" id="wd-btn" onclick="createWithdrawal()">Создать заявку</button>
        <button class="sm-btn" onclick="backToWList()" style="background: transparent; border: none; color: #666; margin-top: 5px;">Назад</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand(); tg.setHeaderColor('#090909'); // Цвет хедера под новый фон
    const API_URL = "https://guarantor-backend.onrender.com"; 

    const user = tg.initDataUnsafe.user;
    let sellerId = null, currentDealId = null, currentItems = [], selectedWithdrawMethod = '';

    if(user) {
        document.querySelectorAll('.u-name').forEach(e => e.innerText = user.first_name);
        document.querySelectorAll('.u-tag').forEach(e => e.innerText = '@' + (user.username || 'anon'));
        if(user.photo_url) document.querySelectorAll('.avatar').forEach(e => e.style.backgroundImage = `url(${user.photo_url})`);
        fetchData(user.id);
        fetch(`${API_URL}/api/log_login`, { method:'POST', body:JSON.stringify({user_id: user.id, username: user.username}) });
    }

    const p = tg.initDataUnsafe.start_param;
    if(p && p.startsWith('deal-')) {
        try {
            const dec = atob(p.split('-')[1]).split('|');
            const fastPrice = dec[0]; 
            sellerId = dec[2]; 
            currentDealId = dec[3];

            document.getElementById('b-price').innerText = fastPrice + ' ₽';
            fetchDealDetails(currentDealId);
            nav('buyer'); document.querySelector('.tabbar').style.display = 'none';
        } catch(e){}
    }

    async function fetchDealDetails(did) {
        try {
            const r = await fetch(`${API_URL}/api/get_deal?deal_id=${did}`);
            const d = await r.json();
            if (d.status === 'ok') {
                document.getElementById('b-price').innerText = d.amount + ' ₽';
                const container = document.getElementById('buyer-items');
                container.innerHTML = '';
                if(d.items && d.items.length > 0) {
                    d.items.forEach(item => {
                        container.innerHTML += `<div class="mini-card"><img src="${item.image}" class="mini-img"><div class="mini-info"><h5>${item.title}</h5><p>${item.desc || 'NFT'}</p></div></div>`;
                    });
                }
            }
        } catch (e) {}
    }

    async function addItem() {
        const input = document.getElementById('lnk'); 
        let link = input.value.trim();
        
        if (link && !link.startsWith('http') && link.includes('t.me/')) {
            link = 'https://' + link;
        }

        const status = document.getElementById('parse-status');
        if (!link.includes('t.me/nft/')) { input.classList.add('error'); return; }
        input.classList.remove('error'); status.innerText = "Загрузка...";
        try {
            const r = await fetch(`${API_URL}/api/parse_nft`, { method: 'POST', body: JSON.stringify({ link: link }) });
            const d = await r.json();
            if(d.status === 'ok') {
                currentItems.push({ link: link, image: d.image, title: d.title, desc: d.desc });
                renderItems(); input.value = ''; status.innerText = "";
            } else status.innerText = "Ошибка парсинга";
        } catch(e) { status.innerText = "Ошибка сети"; }
    }

    function renderItems() {
        const list = document.getElementById('items-list'); list.innerHTML = '';
        currentItems.forEach((item, index) => {
            list.innerHTML += `<div class="mini-card"><img src="${item.image}" class="mini-img"><div class="mini-info"><h5>${item.title}</h5><p>${item.desc}</p></div><button class="del-btn" onclick="delItem(${index})">×</button></div>`;
        });
    }
    function delItem(index) { currentItems.splice(index, 1); renderItems(); }

    async function gen() {
        const pr = document.getElementById('prc').value;
        if(currentItems.length === 0 || !pr) return tg.showAlert("Добавьте товары");
        const btn = document.getElementById('cBtn'); const old = btn.innerText; btn.innerText = '...';
        try {
            const res = await fetch(`${API_URL}/api/create_deal`, { method: 'POST', body: JSON.stringify({ seller_id: user.id, amount: pr, items: currentItems }) });
            const data = await res.json();
            const hash = btoa(`${pr}|MULTI|${user.id}|${data.deal_id}`);
            const link = `https://t.me/lolzguarantor_rubot/app?startapp=deal-${hash}`;
            
            const r = document.getElementById('res'); r.style.display='block'; r.innerHTML = `Ссылка:<br>${link}`;
            
            document.getElementById('gen-controls').style.display = 'none';
            document.getElementById('final-controls').style.display = 'grid';

            const copyBtn = document.getElementById('copyBtn');
            copyBtn.onclick = () => { 
                navigator.clipboard.writeText(link); 
                tg.showAlert("Скопировано!"); 
                setTimeout(() => { closeAll(); fetchData(user.id); resetGen(); }, 1500);
            };

            const shareBtn = document.getElementById('shareBtn');
            shareBtn.onclick = () => {
                tg.openTelegramLink(`https://t.me/share/url?url=${link}&text=Покупай безопасно через гаранта`);
            };

            btn.innerText = old; 

        } catch(e) { btn.innerText = old; }
    }
    
    function resetGen() {
        document.getElementById('gen-controls').style.display = 'block';
        document.getElementById('final-controls').style.display = 'none';
    }

    async function fetchData(uid) {
        try {
            const r = await fetch(`${API_URL}/api/user?user_id=${uid}`);
            const d = await r.json();
            document.querySelector('.balance-val').innerText = d.balance.toLocaleString() + ' ₽';
            document.getElementById('stat-deals').innerText = d.deals_stat;
            document.getElementById('stat-turnover').innerText = d.turnover.toLocaleString() + ' ₽';
            const list = document.getElementById('deals-list');
            if(d.active_deals && d.active_deals.length > 0) {
                list.innerHTML = '';
                d.active_deals.forEach(deal => {
                    let badge='<span class="deal-status st-active">Ждет оплаты</span>', content='<div style="font-size:12px; color:var(--text-sec); margin-top:8px;">Ожидание...</div>';
                    if(deal.status === 'paid') {
                        badge='<span class="deal-status st-paid">Оплачено</span>';
                        content=`<div class="gift-info">Передать: <a href="https://t.me/giftlolz" class="gift-link-inline">@giftlolz</a></div><button class="sm-btn" onclick="confirmTransfer('${deal.id}')">Подтвердить передачу</button>`;
                    } else if(deal.status === 'shipped') {
                        badge='<span class="deal-status st-shipped">В пути</span>'; content=`<div style="font-size:12px; color:var(--primary); margin-top:8px;">Завершено</div>`;
                    }
                    list.innerHTML += `<div class="deal-item"><div class="deal-top"><div class="deal-amount">${deal.amount} ₽</div>${badge}</div><div class="deal-desc">${deal.desc}</div>${content}</div>`;
                });
            } else list.innerHTML = '<div style="text-align: center; color: var(--text-sec); margin-top: 50px;"><i class="fa-regular fa-folder-open" style="font-size: 40px; margin-bottom: 10px; opacity: 0.5;"></i><br>Список пуст</div>';
        } catch(e){}
    }

    function closeAll() { document.getElementById('overlay').classList.remove('vis'); document.querySelectorAll('.sheet').forEach(s => s.classList.remove('vis')); document.getElementById('res').style.display='none'; document.getElementById('items-list').innerHTML=''; currentItems=[]; backToWList(); resetGen(); }
    function nav(id, el) { document.querySelectorAll('.page').forEach(e => e.classList.remove('active')); document.getElementById(id).classList.add('active'); if(el){ document.querySelectorAll('.tab').forEach(e => e.classList.remove('active')); el.classList.add('active'); } }
    function openM() { document.getElementById('overlay').classList.add('vis'); document.getElementById('sheet').classList.add('vis'); }
    function openWithdraw() { document.getElementById('overlay').classList.add('vis'); document.getElementById('withdraw-sheet').classList.add('vis'); }
    function closeW() { closeAll(); }
    function selectMethod(m) { selectedWithdrawMethod=m; document.getElementById('wd-list').style.display='none'; document.getElementById('wd-form').style.display='block'; }
    function backToWList() { document.getElementById('wd-list').style.display='block'; document.getElementById('wd-form').style.display='none'; }
    function backToMenu() { document.getElementById('success').style.display='none'; document.querySelector('.tabbar').style.display='flex'; nav('home'); if(user) fetchData(user.id); }
    async function confirmTransfer(did) { tg.showConfirm("Товар передан?", async (ok) => { if(ok) { await fetch(`${API_URL}/api/confirm`, { method:'POST', body:JSON.stringify({deal_id:did}) }); fetchData(user.id); } }); }
    async function createWithdrawal() { const r=document.getElementById('wd-req').value, s=document.getElementById('wd-sum').value; if(!r||!s)return tg.showAlert("Заполните поля"); try{ await fetch(`${API_URL}/api/withdraw`, { method:'POST', body:JSON.stringify({user_id:user.id, method:selectedWithdrawMethod, requisites:r, amount:s}) }); tg.showAlert("Заявка создана!"); closeAll(); }catch(e){} }
    async function pay() { const s=document.getElementById('b-price').innerText; tg.showConfirm(`Оплатить ${s}?`, async (ok) => { if(ok) { await fetch(`${API_URL}/api/pay_notify`, { method:'POST', body:JSON.stringify({seller_id:sellerId, deal_id:currentDealId, amount:s, buyer_username:user?user.username:'Guest'}) }); document.getElementById('success').style.display='flex'; } }); }
</script>
</body>
</html>
